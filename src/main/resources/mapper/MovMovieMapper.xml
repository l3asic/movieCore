<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.movieCore.movie.mapperInterface.MovMovieMapper">


    <!-- 영화 빈 -->
    <resultMap type="com.example.movieCore.movie.bean.MovieBean" id="MovieBean">
        <result column="movie_cd" property="movieCd" jdbcType="VARCHAR"/>
        <result column="movie_nm" property="movieNm" jdbcType="VARCHAR"/>
        <result column="movie_nm_en" property="movieNmEn" jdbcType="VARCHAR"/>
        <result column="prdt_year" property="prdtYear" jdbcType="VARCHAR"/>
        <result column="open_dt" property="openDt" jdbcType="DATE"/>
        <result column="type_nm" property="typeNm" jdbcType="VARCHAR"/>
        <result column="prdt_stat_nm" property="prdtStatNm" jdbcType="VARCHAR"/>
        <result column="genre_alt" property="genreAlt" jdbcType="VARCHAR"/>
        <result column="rep_genre_nm" property="repGenreNm" jdbcType="VARCHAR"/>

    </resultMap>

    <!-- 관리자 - 영화 리스트 토탈 갯수 조회 -->
    <select id="selectMovieListTotalCntAdmin" parameterType="com.example.movieCore.movie.vo.MovVo" resultType="integer">
        SELECT
        count(MM.movie_cd) totalCnt
        FROM
        MOV_MOVIE MM

        WHERE
        1=1
        /* 제목 검색 */
        <choose>
            <when test="searchFilter == 'movieCd'">
                AND MM.MOVIE_CD LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'movieNm'">
                AND MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'repGenreNm'">
                AND MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <otherwise>
                AND (
                MM.MOVIE_CD LIKE CONCAT('%', #{searchText}, '%')
                OR MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
                OR MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
                )
            </otherwise>
        </choose>
    </select>


    <!-- 관리자 - 영화 리스트 조회 -->
    <select id="selectMovieListAdmin" parameterType="com.example.movieCore.movie.vo.MovVo" resultMap="MovieBean">
        SELECT
        MM.movie_cd,
        MM.movie_nm,
        MM.movie_nm_en,
        MM.prdt_year,
        MM.open_dt,
        MM.type_nm,
        MM.prdt_stat_nm,
        MM.genre_alt,
        MM.rep_genre_nm,
        MM.STATE
        FROM MOV_MOVIE MM
        WHERE 1=1
        /* 제목 검색 */
        <choose>
            <when test="searchFilter == 'movieCd'">
                AND MM.MOVIE_CD LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'movieNm'">
                AND MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'repGenreNm'">
                AND MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <otherwise>
                AND (
                MM.MOVIE_CD LIKE CONCAT('%', #{searchText}, '%')
                OR MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
                OR MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
                )
            </otherwise>
        </choose>

        /* 정렬 */
        <if test="sortKey != null and sortOdr != null">
            ORDER BY
            <choose>
                <when test="sortKey == 'movieCd'">
                    MM.movie_cd
                </when>
                <when test="sortKey == 'movieNm'">
                    MM.movie_nm
                </when>
                <when test="sortKey == 'prdtYear'">
                    MM.prdt_year
                </when>
                <when test="sortKey == 'repGenreNm'">
                    MM.rep_genre_nm
                </when>
                <when test="sortKey == 'state'">
                    MM.state
                </when>
                <otherwise>
                    MM.movie_cd
                </otherwise>
            </choose>
            <if test="sortOdr == 'asc'">
                ASC
            </if>
            <if test="sortOdr == 'desc'">
                DESC
            </if>
        </if>

        /* 페이징 */
        LIMIT #{paging.startIndex}, #{paging.itemsPerPage}
    </select>


    <!-- 영화 상태값 변경 -->
    <update id="updateMovieStateAdmin" parameterType="com.example.movieCore.movie.vo.MovVo">
        UPDATE MOV_MOVIE
        SET STATE = #{mode}
        WHERE MOVIE_CD IN
        <foreach item="movie" collection="movieBeanList" open="(" separator="," close=")">
            #{movie.movieCd}
        </foreach>
    </update>



    <!-- 영화 모듈 - 영화 리스트 토탈 갯수 조회 -->
    <select id="selectMovieListTotalCnt" parameterType="com.example.movieCore.movie.vo.MovVo" resultType="integer">
        SELECT
        count(MM.movie_cd) totalCnt
        FROM
        MOV_MOVIE MM, MOV_MOVIE_INFO MMI

        WHERE
            MM.MOVIE_CD = MMI.MOVIE_CD

            AND MM.STATE = 'B'

          /* 검색) 제목, 대표장르, 개봉년도, 배우명, 관람등급, 전체 */
        <choose>
            <when test="searchFilter == 'movieNm'">
                AND MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'repGenreNm'">
                AND MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'openDt'">
                AND MM.open_dt LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'cast'">
                AND MMI.cast LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'watchGradeNm'">
                AND MMI.watch_grade_nm LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'nationNm'">
                AND MMI.NATION_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>





            <otherwise>
                AND (
                MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
                OR MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')

                OR MM.open_dt LIKE CONCAT('%', #{searchText}, '%')
                OR MMI.cast LIKE CONCAT('%', #{searchText}, '%')
                OR MMI.watch_grade_nm LIKE CONCAT('%', #{searchText}, '%')
                )
            </otherwise>
        </choose>
    </select>


    <!-- 영화 모듈 - 영화 리스트 조회 -->
    <select id="selectMovieList" parameterType="com.example.movieCore.movie.vo.MovVo" resultMap="MovieBean">
        SELECT
        MM.movie_cd,
        MM.movie_nm,
        MM.movie_nm_en,
        MM.prdt_year,
        MM.open_dt,
        MM.type_nm,
        MM.prdt_stat_nm,
        MM.genre_alt,
        MM.rep_genre_nm,
        MM.STATE
        FROM MOV_MOVIE MM, MOV_MOVIE_INFO MMI
        WHERE
            MM.MOVIE_CD = MMI.MOVIE_CD

            AND MM.STATE = 'B'

        /* 검색) 제목, 대표장르, 개봉년도, 배우명, 관람등급, 제작국가, 전체 */
        <choose>
            <when test="searchFilter == 'movieNm'">
                AND MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test="searchFilter == 'repGenreNm'">
                AND MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'openDt'">
                AND MM.open_dt LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'cast'">
                AND MMI.cast LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'watchGradeNm'">
                AND MMI.watch_grade_nm LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <when test="searchFilter == 'nationNm'">
                AND MMI.NATION_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>

            <otherwise>
                AND (
                MM.MOVIE_NM LIKE CONCAT('%', #{searchText}, '%')
                OR MM.REP_GENRE_NM LIKE CONCAT('%', #{searchText}, '%')

                OR MM.open_dt LIKE CONCAT('%', #{searchText}, '%')
                OR MMI.cast LIKE CONCAT('%', #{searchText}, '%')
                OR MMI.watch_grade_nm LIKE CONCAT('%', #{searchText}, '%')
                )
            </otherwise>
        </choose>

        /* 정렬 */
        <if test="sortKey != null and sortOdr != null">
            ORDER BY
            <choose>
                <when test="sortKey == 'movieNm'">
                    MM.movie_nm
                </when>
                <when test="sortKey == 'prdtYear'">
                    MM.prdt_year
                </when>
                <when test="sortKey == 'repGenreNm'">
                    MM.rep_genre_nm
                </when>
                <otherwise>
                    MM.movie_cd
                </otherwise>
            </choose>
            <if test="sortOdr == 'asc'">
                ASC
            </if>
            <if test="sortOdr == 'desc'">
                DESC
            </if>
        </if>

        /* 페이징 */
        LIMIT #{paging.startIndex}, #{paging.itemsPerPage}
    </select>


    <!-- 영화 모듈 - 영화 상세정보 조회 -->
    <select id="selectMovieInfo" parameterType="com.example.movieCore.movie.vo.MovVo" resultMap="MovieBean">
        SELECT
            MM.movie_cd,
            MM.movie_nm,
            MM.movie_nm_en,
            MM.prdt_year,
            MM.open_dt,
            MM.type_nm,
            MM.prdt_stat_nm,
            MM.genre_alt,
            MM.rep_genre_nm,
            MM.STATE
        FROM MOV_MOVIE MM, MOV_MOVIE_INFO MMI
        where MM.MOVIE_CD = MMI.MOVIE_CD
            and MM.movie_cd = #{movieBean.movieCd}
    </select>



</mapper>